<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Shot Tracking</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #4CAF50;
            color: white;
            border-radius: 8px;
        }
        .shot-info {
            background-color: #f9f9f9;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .hole-info {
            background-color: #e3f2fd;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background-color: #fff3e0;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #ff9800;
        }
        .error-message {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ef5350;
            margin: 20px 0;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        .shot-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .shot-type.tee {
            background-color: #4CAF50;
            color: white;
        }
        .shot-type.approach {
            background-color: #2196F3;
            color: white;
        }
        .shot-type.putt {
            background-color: #FF9800;
            color: white;
        }
        .shot-type.other {
            background-color: #9E9E9E;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒï¸ Golf Shot Tracking</h1>
            <p>ê³¨í”„ ë¼ìš´ë“œ ìƒ· ë°ì´í„° ë¶„ì„</p>
        </div>
        
        <div id="content">
            <div class="loading">
                <h3>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h3>
                <p>ìƒ· ë°ì´í„°ê°€ ì „ì†¡ë˜ë©´ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <script>
        // POST ë°ì´í„°ë¥¼ ë°›ê¸° ìœ„í•œ í•¨ìˆ˜
        function handlePostData() {
            // POST ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
            const postData = getPostData();
            
            if (postData && postData.Shots) {
                displayShotData(postData.Shots);
            } else {
                // POST ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
                document.getElementById('content').innerHTML = `
                    <div class="no-data">
                        <h3>ìƒ· ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>Flutter ì•±ì—ì„œ "ìƒ· ë°ì´í„°ë³´ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°ì´í„°ë¥¼ ì „ì†¡í•´ì£¼ì„¸ìš”.</p>
                        <p>ë˜ëŠ” URL íŒŒë¼ë¯¸í„°ë¡œ jsondataë¥¼ ì „ë‹¬í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            }
        }

        // POST ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        function getPostData() {
            // POST ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸ (ì„œë²„ì—ì„œ ì „ë‹¬ëœ ê²½ìš°)
            if (window.postData) {
                return window.postData;
            }
            
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ jsondata í™•ì¸ (ê¸°ì¡´ ë°©ì‹ ì§€ì›)
            const urlParams = new URLSearchParams(window.location.search);
            const jsonData = urlParams.get('jsondata');
            
            if (jsonData) {
                try {
                    return JSON.parse(jsonData);
                } catch (e) {
                    console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', e);
                    return null;
                }
            }
            
            return null;
        }

        // ìƒ· ë°ì´í„°ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function displayShotData(shots) {
            if (!shots || shots.length === 0) {
                document.getElementById('content').innerHTML = `
                    <div class="no-data">
                        <h3>ìƒ· ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>ì „ì†¡ëœ ìƒ· ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }

            // í†µê³„ ê³„ì‚°
            const stats = calculateStats(shots);
            
            // í™€ë³„ë¡œ ìƒ· ê·¸ë£¹í™”
            const holes = groupShotsByHole(shots);
            
            let html = `
                <div class="stats">
                    <div class="stat-card">
                        <h3>ì´ ìƒ· ìˆ˜</h3>
                        <p style="font-size: 24px; font-weight: bold; color: #4CAF50;">${shots.length}</p>
                    </div>
                    <div class="stat-card">
                        <h3>í™€ ìˆ˜</h3>
                        <p style="font-size: 24px; font-weight: bold; color: #2196F3;">${Object.keys(holes).length}</p>
                    </div>
                    <div class="stat-card">
                        <h3>í‰ê·  ìƒ·/í™€</h3>
                        <p style="font-size: 24px; font-weight: bold; color: #FF9800;">${(shots.length / Object.keys(holes).length).toFixed(1)}</p>
                    </div>
                    <div class="stat-card">
                        <h3>ì´ ê±°ë¦¬</h3>
                        <p style="font-size: 24px; font-weight: bold; color: #9C27B0;">${stats.totalDistance.toFixed(1)}m</p>
                    </div>
                </div>
            `;

            // í™€ë³„ ì •ë³´ í‘œì‹œ
            Object.keys(holes).sort((a, b) => parseInt(a) - parseInt(b)).forEach(holeNum => {
                const holeShots = holes[holeNum];
                const holeStats = calculateHoleStats(holeShots);
                
                html += `
                    <div class="hole-info">
                        <h3>í™€ ${parseInt(holeNum) + 1}</h3>
                        <p><strong>ìƒ· ìˆ˜:</strong> ${holeShots.length} | <strong>ì´ ê±°ë¦¬:</strong> ${holeStats.totalDistance.toFixed(1)}m</p>
                `;
                
                holeShots.forEach((shot, index) => {
                    const shotType = getShotTypeText(shot.type);
                    const shotTypeClass = getShotTypeClass(shot.type);
                    
                    html += `
                        <div class="shot-info">
                            <strong>ìƒ· ${index + 1}</strong>
                            <span class="shot-type ${shotTypeClass}">${shotType}</span>
                            <br>
                            <strong>ìœ„ì¹˜:</strong> ${shot.lat.toFixed(6)}, ${shot.lng.toFixed(6)}
                            ${shot.tag ? `<br><strong>íƒœê·¸:</strong> ${shot.tag}` : ''}
                        </div>
                    `;
                });
                
                html += `</div>`;
            });

            document.getElementById('content').innerHTML = html;
        }

        // í†µê³„ ê³„ì‚°
        function calculateStats(shots) {
            let totalDistance = 0;
            
            for (let i = 1; i < shots.length; i++) {
                const prev = shots[i-1];
                const curr = shots[i];
                
                if (prev.hole === curr.hole) {
                    const distance = calculateDistance(prev.lat, prev.lng, curr.lat, curr.lng);
                    totalDistance += distance;
                }
            }
            
            return { totalDistance };
        }

        // í™€ë³„ í†µê³„ ê³„ì‚°
        function calculateHoleStats(holeShots) {
            let totalDistance = 0;
            
            for (let i = 1; i < holeShots.length; i++) {
                const prev = holeShots[i-1];
                const curr = holeShots[i];
                const distance = calculateDistance(prev.lat, prev.lng, curr.lat, curr.lng);
                totalDistance += distance;
            }
            
            return { totalDistance };
        }

        // í™€ë³„ë¡œ ìƒ· ê·¸ë£¹í™”
        function groupShotsByHole(shots) {
            const holes = {};
            
            shots.forEach(shot => {
                if (!holes[shot.hole]) {
                    holes[shot.hole] = [];
                }
                holes[shot.hole].push(shot);
            });
            
            return holes;
        }

        // ê±°ë¦¬ ê³„ì‚° (Haversine ê³µì‹)
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // ì§€êµ¬ ë°˜ì§€ë¦„ (ë¯¸í„°)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ìƒ· íƒ€ì… í…ìŠ¤íŠ¸ ë³€í™˜
        function getShotTypeText(type) {
            switch(type) {
                case 0: return 'í‹°ìƒ·';
                case 1: return 'ì–´í”„ë¡œì¹˜';
                case 2: return 'í¼íŠ¸';
                default: return 'ê¸°íƒ€';
            }
        }

        // ìƒ· íƒ€ì… CSS í´ë˜ìŠ¤
        function getShotTypeClass(type) {
            switch(type) {
                case 0: return 'tee';
                case 1: return 'approach';
                case 2: return 'putt';
                default: return 'other';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            // POST ë°ì´í„° ì²˜ë¦¬
            handlePostData();
            
            // POST ë°ì´í„°ë¥¼ ë°›ê¸° ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í•„ìš”ì‹œ)
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'shotData') {
                    displayShotData(event.data.shots);
                }
            });
        });

        // ì„œë²„ì—ì„œ POST ë°ì´í„°ë¥¼ ë°›ì•˜ì„ ë•Œ í˜¸ì¶œí•  í•¨ìˆ˜
        function setPostData(data) {
            window.postData = data;
            handlePostData();
        }
    </script>
</body>
</html>
